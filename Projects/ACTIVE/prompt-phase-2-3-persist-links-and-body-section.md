# Prompt — Phases 2–3: Persist `suggested_links` + body section

## The prompt

Let's create a new branch for the next feature: **persist-processing-results-phase-2-3-links-and-section**.

We want to perform **TDD** with **Red → Green → Refactor**, followed by **git commit** and **lessons learned documentation**. This equals one iteration.

### Updated Execution Plan (focused P0/P1)

- **Brief context / current priorities**: Parent sprint is **Make InnerOS Usable**. Phase 1 persists `triage_recommendation`. Now we persist discovered connections so `process-note` outputs become visible/queryable without rerunning analysis.
- **Guidance I’m following**:
  - `.windsurf/rules/updated-development-workflow.md` (TDD + test tier discipline)
  - `.windsurf/rules/architectural-constraints.md` (avoid god classes / extract utilities)
  - `.windsurf/guides/ai-integration-patterns.md` (graceful degradation + idempotency)
- **Critical path / current blocker**: Resolved by Phase 2–3 persistence (commit `e3c13e4`).

### Current Status

- **Completed**:
  - Phase 1: `triage_recommendation` persisted in frontmatter.
    - Code committed: `0a7d3b3`
    - Lessons learned: `Projects/COMPLETED-2025-12/persist-triage-recommendation-phase-1-lessons-learned.md`
  - Phase 2–3: `suggested_links` frontmatter + `## Suggested Connections` body section.
    - Code committed: `e3c13e4`
    - GitHub issue: #79 (closed)
    - Lessons learned: `Projects/COMPLETED-2025-12/persist-processing-results-phase-2-3-lessons-learned.md`
    - Prompt (archived canonical copy): `Projects/COMPLETED-2025-12/prompt-phase-2-3-persist-links-and-body-section.md`

### Lessons from last iteration

- Prefer overwrite/idempotent persistence so reruns are safe.
- Preserve user-authored body content; only manage a dedicated system section.

---

## P0 — Critical/Unblocker (P0)

### Main P0 task: Persist `suggested_links` in frontmatter

- **Implementation detail 1**: Derive suggested links from discovered connections (currently `results["processing"]["connections"]["similar_notes"]`).
- **Implementation detail 2**: Persist as YAML list of wikilink strings, max 5 (configurable later).
- **Implementation detail 3**: Deduplicate:
  - against any existing `suggested_links` in frontmatter
  - against links already present in note body
  - within the newly generated list

### Secondary P0 task: Idempotent body section replacement

- **Implementation detail 1**: Append `## Suggested Connections` to end of note body.
- **Implementation detail 2**: If the section already exists, replace it (do not duplicate).
- **Implementation detail 3**: Include timestamp line: `> Auto-generated by InnerOS on ...`.

### Acceptance Criteria

- After `process-note`, frontmatter includes `suggested_links` (max 5, deduped).
- After `process-note`, body includes exactly one `## Suggested Connections` section that is replaced on reruns.

---

## P1 — Architecture/Quality (P1)

- If section manipulation logic grows beyond ~30–50 LOC, extract to a new utility module in `development/src/utils/` (and add unit tests for it).
- Ensure changes are backwards compatible (notes without the new fields/section still work).

---

## P2 — Future improvements (P2)

- Add optional similarity score/reason in the section output.
- Add config for frontmatter-only mode vs body-append mode.

---

## Task Tracker

- **[Complete]** Phase 2 — Persist `suggested_links`
- **[Complete]** Phase 3 — `## Suggested Connections` section replacement
- **[Next]** Phase 4–5 — Batch inbox processing (`make inbox` / `make inbox-safe`)

---

## TDD Cycle Plan

### Red Phase

- Add unit tests in `development/tests/unit/test_note_processing_coordinator.py`:
  - `test_process_note_persists_suggested_links_frontmatter`
  - `test_process_note_appends_suggested_connections_section`
  - `test_process_note_replaces_existing_suggested_connections_section`

### Green Phase

- Implement in `development/src/ai/note_processing_coordinator.py`:
  - compute `suggested_links` from connection results
  - write `frontmatter["suggested_links"] = [...]` before writing
  - update body by appending or replacing the `## Suggested Connections` section

### Refactor Phase

- Extract helpers:
  - `extract_wikilinks_from_body(text) -> set[str]`
  - `replace_or_append_section(body, header, new_block) -> body`
- If helpers grow, move them into `development/src/utils/` and add `test_*` coverage.

---

## Next Action (for this session)

1. See archived prompt: `Projects/COMPLETED-2025-12/prompt-phase-2-3-persist-links-and-body-section.md`.
2. Proceed to Phase 4–5 prompt: `Projects/ACTIVE/prompt-phase-4-5-batch-inbox-processing.md`.
